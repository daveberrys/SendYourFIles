<link rel="stylesheet" href="css/popupStyle.css">
<link rel="stylesheet" href="css/cacaStyle.css">

<script>
    let selectedPath = null;
    let selectedSize = 0; // in bytes

    async function loadPopups() {
        const popups = [
            'sendTo.html',
            'settings.html',
            'credits.html',

            'extra/sendTo-Fallback.html',
            'extra/litterboxTime.html',
            'extra/limiter/catbox.html',
            'extra/limiter/litterbox.html',

            'extra/updaters/newUpdateAvailable.html',
            'extra/updaters/failedToFetch.html',
        ];

        for (const file of popups) {
            try {
                const response = await fetch(`popup/${file}`);
                const html = await response.text();
                document.body.insertAdjacentHTML('beforeend', html);
                console.log(`Loaded popup: ${file}`);
            } catch (e) {
                console.error(`Failed to load ${file}:`, e);
            }
        }
    }

    window.addEventListener('DOMContentLoaded', async () => {
        await loadPopups();
        if (window.pywebview) {
            checkUpdates();
        } else {
            window.addEventListener('pywebviewready', checkUpdates);
        }
    });

    async function chooseFile() {
        try {
            const data = await window.pywebview.api.pickFile();
            if (data) {
                selectedPath = data.path;
                selectedSize = data.size;

                const fileName = data.path.split(/[\\/]/).pop();
                const sizeMB = (data.size / (1024 * 1024)).toFixed(2);

                document.getElementById("logs").innerText = `Selected: ${fileName} (${sizeMB} MB)`;
            }
        } catch (e) {
            console.error("Failed to pick file:", e);
        }
    }

    async function saveSetting(key, value) {
        try {
            await window.pywebview.api.saveSettings(key, value);
        } catch (e) {
            console.error(e);
        }
    }

    async function loadSettings() {
        const container = document.querySelector('#settingsPopup .overflow');
        if (!container) return;
        
        container.innerHTML = '';

        try {
            const data = await window.pywebview.api.getSettings();
            const settings = data.settings;

            if (!settings || Object.keys(settings).length === 0) {
                container.innerHTML = '<p style="padding: 10px; color: white;">No settings found.</p>';
                return;
            }

            for (const key in settings) {
                const item = settings[key];
                
                if (item.type === 'boolean') {
                    const div = document.createElement('div');
                    div.className = 'item settings-item';
                    
                    const isTrue = item.default === 'true';
                    
                    div.innerHTML = `
                        <div class="info">
                            <span class="bigText">${item.name}</span><br>
                            <span>${item.description}</span>
                        </div>

                        <select id="${key}" onchange="saveSetting('${key}', this.value === 'true')">
                            <option value="true" ${isTrue ? 'selected' : ''}>True</option>
                            <option value="false" ${!isTrue ? 'selected' : ''}>False</option>
                        </select>
                    `;
                    
                    container.appendChild(div);
                }
            }
        } catch (error) {
            console.error("Failed to load settings:", error);
            container.innerHTML = "<p>Error loading settings.</p>";
        }
    }

    function showPopup(id) {
        if (id === 'platformPopup' && !selectedPath) {
            showPopup('fallbackPopup');
            return;
        }

        if (id === 'settingsPopup') {
            loadSettings();
            currentLocalVersion();
        }

        const popup = document.getElementById(id);
        if (popup) {
            popup.style.display = "flex";
        }
    }

    function closePopup(id) {
        const popup = document.getElementById(id);
        if (popup) {
            popup.style.display = "none";
        }
    }

    function startLitterboxFlow() {
        closePopup('platformPopup');
        showPopup('litterboxTimePopup');
    }

    // THE ROBUST COPY FUNCTION (stupid, but effective)
    function copyToClipboard(text) {
        // fallback method for non-HTTPS/local contexts
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            return true;
        } catch (err) {
            console.error('Fallback copy failed', err);
            return false;
        } finally {
            document.body.removeChild(textArea);
        }
    }

    async function handleUploadSuccess(result) {
        const logPanel = document.getElementById("logs");

        // check if the result is actually a URL (starts with http)
        if (result && result.startsWith("http")) {
            logPanel.innerText = `Success! (Copied!)\n${result}`;

            // try modern method first, then fallback
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(result);
                } catch (err) {
                    copyToClipboard(result);
                }
            } else {
                copyToClipboard(result);
            }
        } else {
            // it's probably an error message from our Python logic
            logPanel.innerText = result;
        }
    }

    async function litterBoxExpire(timeLabel) {
        closePopup('litterboxTimePopup');
        const time = timeLabel.split(' ')[0].toLowerCase() + 'h';
        const logPanel = document.getElementById("logs");

        logPanel.innerText = `Uploading to Litterbox (${timeLabel})...`;

        try {
            const result = await window.pywebview.api.uploadTo(selectedPath, 'litterbox', time);
            await handleUploadSuccess(result);
        } catch (e) {
            logPanel.innerText = "Error: Upload failed.";
        }
    }

    async function triggerUpload(platform) {
        const sizeMB = selectedSize / (1024 * 1024);
        const logPanel = document.getElementById("logs");

        if (platform === 'catbox' && sizeMB > 200) {
            closePopup('platformPopup');
            showPopup('catboxLimiterPopup');
            return;
        }
        if (platform === 'litterbox' && sizeMB > 1024) {
            closePopup('platformPopup');
            showPopup('litterboxLimiterPopup');
            return;
        }

        if (platform === 'litterbox') {
            startLitterboxFlow();
            return;
        }

        closePopup('platformPopup');
        logPanel.innerText = `Preparing upload to ${platform}...`;

        try {
            const result = await window.pywebview.api.uploadTo(selectedPath, platform);
            await handleUploadSuccess(result);
        } catch (e) {
            logPanel.innerText = "Error: Could not reach the server.";
        }
    }

    async function checkUpdates() {
        try {
            const result = await window.pywebview.api.checkForUpdates();

            if (result.status === "error") {
                showPopup('failedToFetchPopup');
            } else if (result.status === "success" && result.available) {
                const downloadLink = document.getElementById('updateDownloadLink');
                if (downloadLink) {
                    downloadLink.href = `https://github.com/daveberrys/SendYourFiles/releases/tag/${result.latest}`;
                }
                const versionText = document.getElementById('updateVersionText');
                if (versionText) {
                    versionText.innerText = `Latest version: ${result.latest}`;
                }
                showPopup('newUpdateAvailablePopup');
            }
        } catch (e) {
            console.error("Failed to check for updates:", e);
        }
    }

    async function currentLocalVersion() {
        try {
            const result = await window.pywebview.api.localCurrentVersion();
            const versionText = document.getElementById('localCurrentVersion');
            if (versionText && result) {
                versionText.innerText = `Current Local Version: ${result}`;
            }
        } catch (e) {
            console.error("Javascript failed to call get local version:", e);
        }
    }
</script>

<main class="xyCenter">
    <div class="frame">
        <div class="textYap">
            <span class="bigText"> Send Your Files </span>
            <p>Ever wanted to send your files without a restriction?</p>
            <p></p>
        </div>

        <div class="flex" style="gap: 5px;">
            <div class="button" onclick="showPopup('settingsPopup')">Settings</div>
            <div class="button" onclick="showPopup('creditsPopup')">Credits</div>
        </div>
    </div>

    <div class="frame">
        <div class="anotherElem logs">
            <pre id="logs">No logs yet. Send a file!</pre>
        </div>

        <div class="flex" style="gap: 5px;">
            <div class="button" onclick="chooseFile()">Choose File</div>
            <div class="button" onclick="showPopup('platformPopup')">Upload to...</div>
        </div>
    </div>
</main>

<style>
    .logs {
        max-width: 350px;
        scrollbar-width: auto;
        scrollbar-color: var(--frameColor) var(--elemColor);
    }
</style>